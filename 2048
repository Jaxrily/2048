//åŸä½œè€… https://github.com/skyMetaverse
//åœ¨å…¶åŸºç¡€ä¸Šæ”¹è¿› 
(function () {
    const config = {
        targetScore: 10000, // ç›®æ ‡åˆ†æ•°è®¾ç½®ä¸º10000
        moveDelay: 200, // æ¯æ¬¡æ“ä½œçš„å»¶è¿Ÿæ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
        pattern: [0, 1, 0, 1, 2, 1], // æ“ä½œæ¨¡å¼ï¼šå³ã€ä¸‹ã€å·¦ã€ä¸‹ã€å³ã€ä¸‹
        debug: true, // å¯ç”¨è°ƒè¯•æ—¥å¿—
        autoConfirmScore: true, // å¯ç”¨è‡ªåŠ¨æäº¤åˆ†æ•°
        autoRestart: true, // å¯ç”¨è‡ªåŠ¨é‡å¯
        maxLogs: 100 // æœ€å¤§æ—¥å¿—æ•°é‡
    };

    let gameState = {
        running: false, // æ¸¸æˆæ˜¯å¦æ­£åœ¨è¿è¡Œ
        score: 0, // å½“å‰å¾—åˆ†
        moveCount: 0, // æ“ä½œæ¬¡æ•°
        patternIndex: 0, // å½“å‰æ“ä½œæ¨¡å¼çš„ç´¢å¼•
        lastScore: 0, // ä¸Šä¸€æ¬¡è®°å½•çš„å¾—åˆ†
        staleCount: 0, // å¾—åˆ†æœªå˜åŒ–çš„æ¬¡æ•°
        gameLoopTimer: null, // æ¸¸æˆå¾ªç¯çš„å®šæ—¶å™¨
        cachedElements: {} // ç¼“å­˜DOMå…ƒç´ 
    };

    const logHistory = []; // æ—¥å¿—å†å²è®°å½•
    let logCount = 0; // æ—¥å¿—è®¡æ•°

    // æ—¥å¿—å‡½æ•°
    const log = (...args) => {
        if (!config.debug) return;

        logCount++;
        const message = `[2048Bot] ${args.join(' ')}`;
        console.log(message);

        logHistory.push({
            time: new Date(),
            message
        });

        if (logHistory.length > config.maxLogs) {
            logHistory.shift(); // ç§»é™¤æœ€æ—©çš„æ—¥å¿—
        }

        if (logCount % 100 === 0) {
            console.clear(); // æ¯100æ¡æ—¥å¿—æ¸…ç©ºæ§åˆ¶å°
            console.log(`[2048Bot] å·²æ¸…ç©ºæ§åˆ¶å°ï¼Œæ€»æ—¥å¿—æ•°: ${logCount}`);
            logHistory.forEach(entry => {
                console.log(`${entry.time.toISOString().substr(11, 8)} ${entry.message}`);
            });
        }
    };

    const DIRECTIONS = ['ArrowRight', 'ArrowDown', 'ArrowLeft', 'ArrowUp']; // æ“ä½œæ–¹å‘

    // æ¨¡æ‹ŸæŒ‰é”®
    const simulateKeyPress = (key) => {
        log(`æ¨¡æ‹ŸæŒ‰é”®: ${key}`);
        const event = new KeyboardEvent('keydown', {
            key: key,
            code: key,
            bubbles: true,
            cancelable: true
        });
        document.dispatchEvent(event);
    };

    // è·å–ç¼“å­˜çš„DOMå…ƒç´ 
    function getCachedElement(key, finder) {
        if (gameState.cachedElements[key] && document.contains(gameState.cachedElements[key])) {
            return gameState.cachedElements[key];
        }

        const element = finder();
        if (element) {
            gameState.cachedElements[key] = element;
        }
        return element;
    }

    // é€šè¿‡æ–‡æœ¬æŸ¥æ‰¾å…ƒç´ 
    function findElementByText(text, exactMatch = false) {
        const cacheKey = `text_${text}_${exactMatch}`;

        return getCachedElement(cacheKey, () => {
            let found = null;
            document.querySelectorAll('div, button').forEach(el => {
                const elText = el.textContent.trim();
                if ((exactMatch && elText === text) ||
                    (!exactMatch && elText.includes(text))) {
                    found = el;
                }
            });
            return found;
        });
    }

    // æŸ¥æ‰¾åˆ†æ•°å…ƒç´ 
    function findScoreElement() {
        return getCachedElement('scoreElement', () => {
            let scoreElement = null;

            document.querySelectorAll('div').forEach(div => {
                if (div.textContent === 'SCORE') {
                    const parent = div.parentElement;
                    if (parent) {
                        const numbers = parent.querySelectorAll('div');
                        for (const el of numbers) {
                            if (/^\d+$/.test(el.textContent.trim())) {
                                scoreElement = el;
                                log(`æ‰¾åˆ°åˆ†æ•°å…ƒç´ : ${el.textContent}`);
                                break;
                            }
                        }
                    }
                }
            });

            if (!scoreElement) {
                document.querySelectorAll('div').forEach(div => {
                    const text = div.textContent.trim();
                    if (/^\d+$/.test(text) && text.length < 6) {
                        scoreElement = div;
                    }
                });
            }

            return scoreElement;
        });
    }

    // è·å–å½“å‰å¾—åˆ†
    function getCurrentScore() {
        const scoreElement = findScoreElement();
        if (!scoreElement) return 0;

        const text = scoreElement.textContent.trim();
        const score = parseInt(text, 10);
        return isNaN(score) ? 0 : score;
    }

    // æ¸…é™¤æ‰€æœ‰å®šæ—¶å™¨
    function clearAllTimers() {
        if (gameState.gameLoopTimer) {
            clearTimeout(gameState.gameLoopTimer);
            gameState.gameLoopTimer = null;
        }

        if (gameState.confirmTimer) {
            clearTimeout(gameState.confirmTimer);
            gameState.confirmTimer = null;
        }

        if (gameState.restartTimer) {
            clearTimeout(gameState.restartTimer);
            gameState.restartTimer = null;
        }
    }

    // åˆ¤æ–­æ¸¸æˆæ˜¯å¦ç»“æŸ
    function isGameOver() {
        const gameOverElement = findElementByText('Game Over', false);
        if (gameOverElement) return true;

        const confirmScoreButton = findElementByText('CONFIRM SCORE', true);
        if (confirmScoreButton) return true;

        const tryAgainButton = findElementByText('Try Again', true);
        if (tryAgainButton) return true;

        return false;
    }

    // å¤„ç†æ¸¸æˆç»“æŸ
    function handleGameOver() {
        log('æ£€æµ‹åˆ°æ¸¸æˆç»“æŸï¼Œæ­£åœ¨å¤„ç†...');

        gameState.running = false;
        clearAllTimers();

        const currentScore = getCurrentScore();
        log(`æ¸¸æˆç»“æŸï¼Œæœ€ç»ˆå¾—åˆ†: ${currentScore}, æœ€é«˜æ–¹å—: ${getHighestTile() || 'æœªçŸ¥'}`);
        log(`æœ¬å±€æ¸¸æˆæ€»æ“ä½œæ¬¡æ•°: ${gameState.moveCount}`);
        log('æ¸¸æˆç»“æŸï¼Œæš‚åœ5ç§’...');

        setTimeout(() => {
            log('5ç§’æš‚åœç»“æŸï¼Œç»§ç»­å¤„ç†æ¸¸æˆç»“æŸ');

            if (currentScore >= config.targetScore) {
                log(`ğŸ‰ è¾¾åˆ°ç›®æ ‡åˆ†æ•° ${config.targetScore}! å‡†å¤‡æäº¤åˆ†æ•°`);

                if (config.autoConfirmScore) {
                    const confirmScoreButton = findElementByText('CONFIRM SCORE', true);
                    if (confirmScoreButton) {
                        log('ç‚¹å‡»ç¡®è®¤åˆ†æ•°æŒ‰é’® (CONFIRM SCORE)');
                        confirmScoreButton.click();

                        gameState.confirmTimer = setTimeout(() => {
                            const confirmButton = findElementByText('Confirm', true);
                            if (confirmButton) {
                                log('ç‚¹å‡»äºŒæ¬¡ç¡®è®¤æŒ‰é’® (Confirm)');
                                confirmButton.click();

                                gameState.restartTimer = setTimeout(() => {
                                    if (config.autoRestart) {
                                        log('åˆ†æ•°æäº¤å®Œæˆï¼Œå‡†å¤‡é‡å¯æ¸¸æˆ');
                                        restartGame();
                                    }
                                }, 2500);
                            } else {
                                log('æœªæ‰¾åˆ°äºŒæ¬¡ç¡®è®¤æŒ‰é’®ï¼Œå°è¯•ç»§ç»­...');
                                if (config.autoRestart) {
                                    restartGame();
                                }
                            }
                        }, 1500);

                        return;
                    } else {
                        log('æœªæ‰¾åˆ°ç¡®è®¤åˆ†æ•°æŒ‰é’®ï¼Œå°è¯•å…¶ä»–æ–¹æ³•');
                    }
                }
            } else {
                log(`å¾—åˆ† (${currentScore}) æœªè¾¾åˆ°ç›®æ ‡ (${config.targetScore}), ä¸æäº¤åˆ†æ•°ï¼Œç›´æ¥é‡å¯`);
                if (config.autoRestart) {
                    restartGame();
                }
            }
        }, 5000);
    }

    // è·å–æœ€é«˜æ–¹å—çš„å€¼
    function getHighestTile() {
        try {
            let highestNumber = 0;
            document.querySelectorAll('.tile').forEach(tile => {
                const tileText = tile.textContent.trim();
                const tileValue = parseInt(tileText, 10);
                if (!isNaN(tileValue) && tileValue > highestNumber) {
                    highestNumber = tileValue;
                }
            });
            return highestNumber || null;
        } catch (e) {
            return null;
        }
    }

    // æŒ‰ç…§æ¨¡å¼æ‰§è¡Œæ“ä½œ
    function moveWithPattern() {
        const directionIndex = config.pattern[gameState.patternIndex];
        simulateKeyPress(DIRECTIONS[directionIndex]);

        gameState.patternIndex = (gameState.patternIndex + 1) % config.pattern.length;
    }

    // é‡ç½®æ¸¸æˆçŠ¶æ€
    function resetGameState() {
        gameState.moveCount = 0;
        gameState.patternIndex = 0;
        gameState.staleCount = 0;
        gameState.lastScore = 0;

        gameState.cachedElements = {};
    }

    // é‡å¯æ¸¸æˆ
    function restartGame() {
        log('å°è¯•é‡å¯æ¸¸æˆ');

        clearAllTimers();

        const newGameButton = findElementByText('New Game', true);
        if (newGameButton) {
            newGameButton.click();
            log('ç‚¹å‡»æ–°æ¸¸æˆæŒ‰é’®');

            resetGameState();

            gameState.restartTimer = setTimeout(() => {
                gameState.running = true;
                startGameLoop();
                log('æ¸¸æˆå¾ªç¯å·²é‡å¯');
            }, 2000);

            return true;
        } else {
            log('æœªæ‰¾åˆ°æ–°æ¸¸æˆæŒ‰é’®');
            return false;
        }
    }

    // å¯åŠ¨æ¸¸æˆå¾ªç¯
    function startGameLoop() {
        if (gameState.gameLoopTimer) {
            clearTimeout(gameState.gameLoopTimer);
        }

        gameLoop();
    }

    // æ¸¸æˆå¾ªç¯
    function gameLoop() {
        if (!gameState.running) return;

        if (isGameOver()) {
            handleGameOver();
            return;
        }

        try {
            const currentScore = getCurrentScore();

            if (currentScore !== gameState.lastScore) {
                log(`å½“å‰å¾—åˆ†: ${currentScore}, æ“ä½œæ¬¡æ•°: ${gameState.moveCount}`);
            }

            if (currentScore === gameState.lastScore) {
                gameState.staleCount++;

                if (gameState.staleCount % 10 === 0) {
                    log(`å¾—åˆ†æœªå˜åŒ–: ${gameState.staleCount}/40`);
                }

                if (gameState.staleCount > 40) {
                    log('æ¸¸æˆå¯èƒ½å¡ä½ï¼Œæ‰§è¡Œå‘ä¸Šæ“ä½œä»¥æ‰“ç ´åƒµå±€');
                    simulateKeyPress(DIRECTIONS[3]);
                    gameState.staleCount = 0;
                }
            } else {
                gameState.staleCount = 0;
            }

            gameState.lastScore = currentScore;

            if (currentScore >= config.targetScore && !gameState.targetReached) {
                log(`ğŸ‰ è¾¾åˆ°ç›®æ ‡åˆ†æ•° ${config.targetScore}! ç­‰å¾…æ¸¸æˆç»“æŸ`);
                gameState.targetReached = true;
            }

            moveWithPattern();
            gameState.moveCount++;

            gameState.gameLoopTimer = setTimeout(gameLoop, config.moveDelay);
        } catch (err) {
            log(`æ¸¸æˆå¾ªç¯é”™è¯¯: ${err.message}`);
            gameState.gameLoopTimer = setTimeout(gameLoop, config.moveDelay * 2);
        }
    }

    // æ‰‹åŠ¨æ“ä½œ
    function manualMove(directionIndex) {
        if (directionIndex >= 0 && directionIndex < 4) {
            simulateKeyPress(DIRECTIONS[directionIndex]);
            return true;
        }
        return false;
    }

    // å¯åŠ¨æœºå™¨äºº
    function start() {
        log('å¯åŠ¨2048æ¸¸æˆè‡ªåŠ¨åŒ–è„šæœ¬ - ä¼˜åŒ–ç‰ˆ');

        stop();

        resetGameState();
        gameState.running = true;
        gameState.targetReached = false;

        startGameLoop();
    }

    // åœæ­¢æœºå™¨äºº
    function stop() {
        log('åœæ­¢2048æ¸¸æˆè‡ªåŠ¨åŒ–è„šæœ¬');
        gameState.running = false;
        clearAllTimers();
    }

    // è·å–å†…å­˜ä½¿ç”¨æƒ…å†µ
    function getMemoryUsage() {
        if (window.performance && window.performance.memory) {
            const memory = window.performance.memory;
            return {
                totalJSHeapSize: (memory.totalJSHeapSize / (1024 * 1024)).toFixed(2) + ' MB',
                usedJSHeapSize: (memory.usedJSHeapSize / (1024 * 1024)).toFixed(2) + ' MB',
                jsHeapSizeLimit: (memory.jsHeapSizeLimit / (1024 * 1024)).toFixed(2) + ' MB'
            };
        }
        return 'æµè§ˆå™¨ä¸æ”¯æŒå†…å­˜ç›‘æ§';
    }

    // æ¸…ç†èµ„æº
    function cleanup() {
        stop();
        gameState.cachedElements = {};
        while (logHistory.length > 0) logHistory.pop();
        console.clear();
        log('æ¸…ç†å®Œæˆï¼Œèµ„æºå·²é‡Šæ”¾');
    }

    // æš´éœ²API
    window.game2048Bot = {
        start,
        stop,
        restart: restartGame,
        right: () => manualMove(0),
        down: () => manualMove(1),
        left: () => manualMove(2),
        up: () => manualMove(3),
        config,
        getMemory: getMemoryUsage,
        cleanup
    };

    log('2048æ¸¸æˆè„šæœ¬å·²åŠ è½½ã€‚å¼€å§‹è‡ªåŠ¨æ¸¸æˆï¼');
    start();
})();
